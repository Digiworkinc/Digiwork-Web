<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Air Mineral</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 600px;
        }
        .modal {
            background-color: rgba(0, 0, 0, 0.7);
        }
        .chat-bubble {
            max-width: 80%;
        }
        .chat-user {
            background-color: #3b82f6;
            color: white;
            border-bottom-right-radius: 0;
        }
        .chat-bot {
            background-color: #e5e7eb;
            color: #1f2937;
            border-bottom-left-radius: 0;
        }
        .btn-primary {
            background-color: #059669;
            transition: background-color 0.3s;
        }
        .btn-primary:hover {
            background-color: #047857;
        }
        .btn-secondary {
            background-color: #6b7280;
            transition: background-color 0.3s;
        }
        .btn-secondary:hover {
            background-color: #4b5563;
        }
        .input-text {
            border: 1px solid #d1d5db;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center p-4 min-h-screen">

    <div id="loading" class="fixed inset-0 flex items-center justify-center bg-white bg-opacity-75 z-50 hidden">
        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-emerald-500"></div>
    </div>

    <div class="container bg-white p-6 rounded-3xl shadow-lg w-full">

        <!-- Header -->
        <div class="flex flex-col items-center mb-6 text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-emerald-600 mb-2">Pesan Air Mineral</h1>
            <p class="text-gray-500 text-sm">Kemudahan memesan air mineral di ujung jari Anda.</p>
            <div id="user-id-display" class="mt-2 p-2 text-xs bg-gray-100 text-gray-500 rounded-lg">ID Pengguna: loading...</div>
        </div>

        <!-- Order Form -->
        <div id="order-section">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Informasi Pemesan</h2>
            <div class="space-y-4 mb-6">
                <input type="text" id="name" placeholder="Nama Anda" class="input-text w-full p-3 rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500" required>
                <input type="tel" id="phone" placeholder="Nomor Telepon (WhatsApp)" class="input-text w-full p-3 rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500" required>
                <input type="email" id="email" placeholder="Alamat Email" class="input-text w-full p-3 rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500">
                <textarea id="address" placeholder="Alamat Lengkap" class="input-text w-full p-3 rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500" rows="3" required></textarea>
            </div>

            <h2 class="text-xl font-semibold text-gray-700 mb-4">Pilih Produk</h2>
            <div id="product-list" class="space-y-4 mb-6">
                <!-- Products will be loaded here -->
            </div>

            <button id="order-button" class="btn-primary w-full text-white font-bold py-3 px-4 rounded-xl shadow-md">
                Pesan Sekarang
            </button>
        </div>

        <!-- Order History/Report Section -->
        <div id="report-section" class="hidden mt-8">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Riwayat Pesanan Anda</h2>
            <div id="order-history" class="space-y-4">
                <!-- Order history will be loaded here -->
            </div>
            <button id="back-to-order-button" class="btn-secondary w-full text-white font-bold py-3 px-4 rounded-xl mt-6">
                Pesan Lagi
            </button>
        </div>

        <!-- Admin Section -->
        <div id="admin-login-section" class="hidden mt-8">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Login Admin</h2>
            <input type="password" id="admin-password" placeholder="Password Admin" class="input-text w-full p-3 rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500 mb-4">
            <button id="admin-login-button" class="btn-primary w-full text-white font-bold py-3 px-4 rounded-xl">
                Login
            </button>
        </div>

        <div id="admin-panel" class="hidden mt-8">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Panel Admin</h2>
            <div id="stock-list" class="space-y-4 mb-4">
                <!-- Stock list will be loaded here -->
            </div>
            <button id="logout-admin-button" class="btn-secondary w-full text-white font-bold py-3 px-4 rounded-xl">
                Logout
            </button>
        </div>

        <!-- Chatbot Button -->
        <div class="fixed bottom-6 right-6 z-40">
            <button id="chatbot-button" class="bg-emerald-600 text-white rounded-full p-4 shadow-lg hover:bg-emerald-700 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
                </svg>
            </button>
        </div>

        <!-- Chatbot Modal -->
        <div id="chatbot-modal" class="modal fixed inset-0 flex items-end justify-center z-50 hidden">
            <div class="bg-white rounded-t-3xl shadow-2xl p-6 w-full max-w-sm md:max-w-md h-[70vh] flex flex-col">
                <div class="flex justify-between items-center pb-4 border-b">
                    <h3 class="font-semibold text-gray-700">Chatbot Layanan Pelanggan</h3>
                    <button id="close-chatbot-button" class="text-gray-500 hover:text-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div id="chatbot-messages" class="flex-grow overflow-y-auto space-y-4 py-4">
                    <!-- Chat messages will appear here -->
                </div>
                <div class="flex mt-auto pt-4 border-t">
                    <input type="text" id="chatbot-input" placeholder="Tanyakan sesuatu..." class="input-text flex-grow p-3 rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500">
                    <button id="chatbot-send-button" class="ml-2 bg-emerald-600 text-white rounded-xl px-4 py-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Modal for Alerts -->
        <div id="alert-modal" class="modal fixed inset-0 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full">
                <h3 id="alert-title" class="text-xl font-semibold mb-2"></h3>
                <p id="alert-message" class="text-gray-600 mb-4"></p>
                <button id="alert-ok-button" class="btn-primary w-full text-white font-bold py-3 px-4 rounded-xl">OK</button>
            </div>
        </div>

        <p class="text-center text-gray-400 text-xs mt-8">Tekan tombol admin di bawah untuk masuk.</p>
        <div class="flex justify-center mt-2">
            <button id="admin-toggle-button" class="text-sm text-blue-500 hover:underline">Masuk Admin</button>
        </div>

    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Atur level log untuk debugging
        setLogLevel('debug');

        // Gunakan variabel global yang disediakan oleh Canvas
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Inisialisasi Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // UI Elements
        const loadingSpinner = document.getElementById('loading');
        const orderSection = document.getElementById('order-section');
        const reportSection = document.getElementById('report-section');
        const adminLoginSection = document.getElementById('admin-login-section');
        const adminPanel = document.getElementById('admin-panel');
        const adminToggleButton = document.getElementById('admin-toggle-button');
        const adminLoginButton = document.getElementById('admin-login-button');
        const logoutAdminButton = document.getElementById('logout-admin-button');
        const orderButton = document.getElementById('order-button');
        const backToOrderButton = document.getElementById('back-to-order-button');
        const userIdDisplay = document.getElementById('user-id-display');
        const productList = document.getElementById('product-list');
        const orderHistoryDiv = document.getElementById('order-history');
        const chatbotButton = document.getElementById('chatbot-button');
        const chatbotModal = document.getElementById('chatbot-modal');
        const closeChatbotButton = document.getElementById('close-chatbot-button');
        const chatbotMessages = document.getElementById('chatbot-messages');
        const chatbotInput = document.getElementById('chatbot-input');
        const chatbotSendButton = document.getElementById('chatbot-send-button');
        const alertModal = document.getElementById('alert-modal');
        const alertTitle = document.getElementById('alert-title');
        const alertMessage = document.getElementById('alert-message');
        const alertOkButton = document.getElementById('alert-ok-button');

        let userId = null;
        let isAdmin = false;

        const defaultProducts = {
            galon: { name: "Air Mineral Galon", stock: 100 },
            cup: { name: "Air Mineral Cup", stock: 500 },
            botol: { name: "Air Mineral Botol", stock: 200 }
        };
        let currentProducts = {};

        // Helper untuk menampilkan modal alert
        function showAlert(title, message) {
            alertTitle.textContent = title;
            alertMessage.textContent = message;
            alertModal.classList.remove('hidden');
        }

        alertOkButton.onclick = () => {
            alertModal.classList.add('hidden');
        };

        // --- Firebase & Auth Setup ---
        (async () => {
            loadingSpinner.classList.remove('hidden');
            try {
                console.log("Memulai proses otentikasi...");
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("Login dengan token berhasil.");
                } else {
                    await signInAnonymously(auth);
                    console.log("Login anonim berhasil.");
                }
            } catch (error) {
                console.error("Autentikasi Firebase gagal:", error);
                showAlert('Autentikasi Gagal', 'Terjadi kesalahan saat otentikasi. Silakan coba lagi.');
            }

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    userIdDisplay.textContent = `ID Pengguna: ${userId}`;
                    console.log("Pengguna terotentikasi. UID:", userId);
                    await fetchStock();
                    await setupOrderListener();
                } else {
                    userId = crypto.randomUUID();
                    userIdDisplay.textContent = `ID Pengguna: ${userId} (Anonim)`;
                    console.log("Tidak ada pengguna terotentikasi. Menggunakan UUID acak:", userId);
                    await fetchStock();
                }
                loadingSpinner.classList.add('hidden');
            });
        })();


        // --- Firebase Firestore Functions ---
        const STOCK_DOC_PATH = `/artifacts/${appId}/public/data/stock/water_products`;

        async function fetchStock() {
            if (!userId) {
                console.log("fetchStock dibatalkan: userId tidak tersedia.");
                return;
            }
            try {
                const docRef = doc(db, STOCK_DOC_PATH);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    currentProducts = docSnap.data();
                    renderProducts();
                    renderStockList();
                    console.log("Stok berhasil diambil.");
                } else {
                    console.warn("Dokumen stok tidak ditemukan, membuat stok default.");
                    await setDoc(docRef, defaultProducts);
                    currentProducts = defaultProducts;
                    renderProducts();
                    renderStockList();
                }
            } catch (e) {
                console.error("Gagal mengambil stok:", e);
                showAlert('Error', 'Gagal memuat data stok.');
            }
        }

        async function updateStock(product, newStock) {
            if (!userId) {
                console.log("updateStock dibatalkan: userId tidak tersedia.");
                return;
            }
            try {
                const docRef = doc(db, STOCK_DOC_PATH);
                await updateDoc(docRef, { [product]: { ...currentProducts[product], stock: newStock } });
            } catch (e) {
                console.error("Gagal memperbarui stok:", e);
                showAlert('Error', 'Gagal memperbarui stok.');
            }
        }

        function getUserOrdersPath(uid) {
            return `/artifacts/${appId}/users/${uid}/orders`;
        }

        async function saveOrder(orderData) {
            if (!userId) {
                console.log("saveOrder dibatalkan: userId tidak tersedia.");
                return;
            }
            try {
                // Gunakan JSON.stringify untuk data kompleks jika perlu, meskipun di sini tidak terlalu kompleks
                const serializedOrder = {
                    ...orderData,
                    timestamp: new Date().toISOString()
                };
                const ordersCollectionRef = collection(db, `/artifacts/${appId}/public/data/orders`);
                const ordersPublicRef = collection(db, getUserOrdersPath(userId));

                // Simpan ke riwayat publik untuk umum
                await setDoc(doc(ordersCollectionRef, orderData.orderId), serializedOrder);
                // Simpan ke riwayat pengguna pribadi
                await setDoc(doc(ordersPublicRef, orderData.orderId), serializedOrder);

                showAlert('Pesanan Diterima', 'Pesanan Anda telah berhasil dicatat!');
                console.log("Pesanan berhasil disimpan di Firestore");
            } catch (e) {
                console.error("Gagal menyimpan pesanan:", e);
                showAlert('Error', 'Gagal menyimpan pesanan. Silakan coba lagi.');
            }
        }

        async function setupOrderListener() {
            if (!userId) {
                console.log("setupOrderListener dibatalkan: userId tidak tersedia.");
                return;
            }
            const q = collection(db, getUserOrdersPath(userId));
            onSnapshot(q, (snapshot) => {
                const orders = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    // Parse data jika perlu
                    orders.push(data);
                });
                renderOrderHistory(orders);
                console.log("Mendengarkan perubahan pesanan...");
            }, (error) => {
                console.error("Gagal mendengarkan pembaruan pesanan:", error);
            });
        }

        // --- UI Rendering Functions ---
        function renderProducts() {
            productList.innerHTML = '';
            Object.keys(currentProducts).forEach(key => {
                const product = currentProducts[key];
                const productCard = document.createElement('div');
                productCard.className = `flex items-center justify-between p-4 bg-gray-50 rounded-xl shadow-sm border border-gray-200`;
                productCard.innerHTML = `
                    <div class="flex-grow">
                        <p class="font-bold text-gray-800">${product.name}</p>
                        <p class="text-sm text-gray-500">Tersedia: ${product.stock} unit</p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button class="quantity-minus-button p-2 text-gray-600 rounded-full hover:bg-gray-200" data-product="${key}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M5 10a1 1 0 011-1h8a1 1 0 110 2H6a1 1 0 01-1-1z" clip-rule="evenodd" />
                            </svg>
                        </button>
                        <span id="quantity-${key}" class="quantity-value font-bold text-lg w-8 text-center">0</span>
                        <button class="quantity-plus-button p-2 text-gray-600 rounded-full hover:bg-gray-200" data-product="${key}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                `;
                productList.appendChild(productCard);
            });
            setupQuantityButtons();
        }

        function setupQuantityButtons() {
            document.querySelectorAll('.quantity-plus-button').forEach(button => {
                button.onclick = (e) => {
                    const productKey = e.currentTarget.dataset.product;
                    const quantitySpan = document.getElementById(`quantity-${productKey}`);
                    let quantity = parseInt(quantitySpan.textContent);
                    if (quantity < currentProducts[productKey].stock) {
                        quantity++;
                        quantitySpan.textContent = quantity;
                    } else {
                         showAlert('Stok Habis', `Stok ${currentProducts[productKey].name} tidak mencukupi.`);
                    }
                };
            });
            document.querySelectorAll('.quantity-minus-button').forEach(button => {
                button.onclick = (e) => {
                    const productKey = e.currentTarget.dataset.product;
                    const quantitySpan = document.getElementById(`quantity-${productKey}`);
                    let quantity = parseInt(quantitySpan.textContent);
                    if (quantity > 0) {
                        quantity--;
                        quantitySpan.textContent = quantity;
                    }
                };
            });
        }

        function renderOrderHistory(orders) {
            orderHistoryDiv.innerHTML = '';
            if (orders.length === 0) {
                orderHistoryDiv.innerHTML = '<p class="text-gray-500 text-center">Anda belum memiliki riwayat pesanan.</p>';
                return;
            }
            orders.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            orders.forEach(order => {
                const orderCard = document.createElement('div');
                orderCard.className = 'p-4 bg-white rounded-xl shadow-md border border-gray-200';
                const orderedItems = order.items.map(item => `
                    <li><span class="font-medium">${item.name}</span>: ${item.quantity} unit</li>
                `).join('');

                orderCard.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <p class="font-bold text-gray-800">Pesanan ${new Date(order.timestamp).toLocaleDateString('id-ID')}</p>
                        <button class="btn-primary text-white font-semibold py-1 px-3 rounded-lg text-sm whatsapp-button" data-order='${JSON.stringify(order)}'>
                            Kirim WA
                        </button>
                    </div>
                    <p class="text-sm text-gray-600 mb-2"><strong>Nama:</strong> ${order.name}</p>
                    <p class="text-sm text-gray-600 mb-2"><strong>Alamat:</strong> ${order.address}</p>
                    <p class="text-sm text-gray-600 mb-2"><strong>ID Pesanan:</strong> <br class="md:hidden">${order.orderId}</p>
                    <ul class="text-sm text-gray-600 list-disc list-inside mt-2">
                        ${orderedItems}
                    </ul>
                `;
                orderHistoryDiv.appendChild(orderCard);
            });
            setupWhatsAppButtons();
        }
        
        function setupWhatsAppButtons() {
             document.querySelectorAll('.whatsapp-button').forEach(button => {
                button.onclick = (e) => {
                    const order = JSON.parse(e.currentTarget.dataset.order);
                    const itemsText = order.items.map(item => `- ${item.name}: ${item.quantity} unit`).join('\n');
                    const message = `Halo, saya ingin melaporkan pesanan baru:\n\n*ID Pesanan:* ${order.orderId}\n*Nama:* ${order.name}\n*No. HP:* ${order.phone}\n*Email:* ${order.email}\n*Alamat:* ${order.address}\n\n*Rincian Pesanan:*\n${itemsText}\n\nTerima kasih.`;
                    const whatsappNumber = '6287878234307'; // Ganti 087... menjadi 6287...
                    const whatsappLink = `https://wa.me/${whatsappNumber}?text=${encodeURIComponent(message)}`;
                    window.open(whatsappLink, '_blank');
                };
            });
        }


        function renderStockList() {
            const stockListDiv = document.getElementById('stock-list');
            stockListDiv.innerHTML = '';
            Object.keys(currentProducts).forEach(key => {
                const product = currentProducts[key];
                const stockItem = document.createElement('div');
                stockItem.className = 'flex items-center space-x-2 p-4 bg-gray-50 rounded-xl shadow-sm border border-gray-200';
                stockItem.innerHTML = `
                    <p class="flex-grow font-bold">${product.name}</p>
                    <input type="number" id="stock-input-${key}" value="${product.stock}" class="w-20 p-2 text-center rounded-lg border focus:outline-none focus:ring-2 focus:ring-emerald-500">
                    <button class="update-stock-button btn-primary text-white font-semibold py-2 px-4 rounded-lg text-sm" data-product="${key}">Update</button>
                `;
                stockListDiv.appendChild(stockItem);
            });
            setupStockUpdateButtons();
        }

        function setupStockUpdateButtons() {
            document.querySelectorAll('.update-stock-button').forEach(button => {
                button.onclick = (e) => {
                    const productKey = e.currentTarget.dataset.product;
                    const stockInput = document.getElementById(`stock-input-${productKey}`);
                    const newStock = parseInt(stockInput.value);
                    if (!isNaN(newStock) && newStock >= 0) {
                        updateStock(productKey, newStock);
                        showAlert('Sukses', `Stok ${currentProducts[productKey].name} berhasil diperbarui.`);
                    } else {
                        showAlert('Input Tidak Valid', 'Masukkan jumlah stok yang valid.');
                    }
                };
            });
        }

        // --- Event Listeners ---
        orderButton.onclick = async () => {
            const name = document.getElementById('name').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const email = document.getElementById('email').value.trim();
            const address = document.getElementById('address').value.trim();

            if (!name || !phone || !address) {
                showAlert('Form Tidak Lengkap', 'Nama, Nomor Telepon, dan Alamat harus diisi.');
                return;
            }

            const items = [];
            let totalQuantity = 0;
            Object.keys(currentProducts).forEach(key => {
                const quantity = parseInt(document.getElementById(`quantity-${key}`).textContent);
                if (quantity > 0) {
                    items.push({ name: currentProducts[key].name, quantity: quantity, productKey: key });
                    totalQuantity += quantity;
                }
            });

            if (items.length === 0) {
                showAlert('Pesanan Kosong', 'Pilih minimal satu produk untuk dipesan.');
                return;
            }

            const orderId = `${userId.substring(0, 8)}-${Date.now()}`;
            const orderData = {
                orderId,
                name,
                phone,
                email,
                address,
                items,
                userId: userId,
            };

            loadingSpinner.classList.remove('hidden');
            await saveOrder(orderData);
            
            // Perbarui stok secara lokal dan di database
            for (const item of items) {
                const newStock = currentProducts[item.productKey].stock - item.quantity;
                currentProducts[item.productKey].stock = newStock;
                await updateStock(item.productKey, newStock);
            }
            renderProducts();
            loadingSpinner.classList.add('hidden');
            
            // Tampilkan riwayat pesanan
            orderSection.classList.add('hidden');
            reportSection.classList.remove('hidden');
            document.getElementById('name').value = '';
            document.getElementById('phone').value = '';
            document.getElementById('email').value = '';
            document.getElementById('address').value = '';
            Object.keys(currentProducts).forEach(key => {
                document.getElementById(`quantity-${key}`).textContent = '0';
            });
        };

        backToOrderButton.onclick = () => {
            orderSection.classList.remove('hidden');
            reportSection.classList.add('hidden');
        };

        adminToggleButton.onclick = () => {
            if (isAdmin) {
                isAdmin = false;
                adminPanel.classList.add('hidden');
                orderSection.classList.remove('hidden');
                adminToggleButton.textContent = 'Masuk Admin';
            } else {
                orderSection.classList.add('hidden');
                reportSection.classList.add('hidden');
                adminLoginSection.classList.remove('hidden');
                adminToggleButton.textContent = 'Kembali';
            }
        };

        adminLoginButton.onclick = () => {
            const password = document.getElementById('admin-password').value;
            // Password hardcode untuk demo. Dalam aplikasi nyata, gunakan otentikasi Firebase.
            if (password === '1234') {
                isAdmin = true;
                adminLoginSection.classList.add('hidden');
                adminPanel.classList.remove('hidden');
                showAlert('Sukses', 'Berhasil masuk sebagai admin!');
                renderStockList();
            } else {
                showAlert('Login Gagal', 'Password salah.');
            }
        };

        logoutAdminButton.onclick = () => {
            isAdmin = false;
            adminPanel.classList.add('hidden');
            orderSection.classList.remove('hidden');
            adminToggleButton.textContent = 'Masuk Admin';
        };

        // --- Chatbot Logic ---
        const BOT_NAME = "Bot";
        const CHAT_MODEL = "gemini-2.5-flash-preview-05-20";
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${CHAT_MODEL}:generateContent?key=`;

        async function fetchChatResponse(prompt) {
            loadingSpinner.classList.remove('hidden');
            const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const payload = {
                contents: chatHistory,
                // Gunakan grounding dengan Google Search jika diperlukan
                // tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: "Anda adalah asisten chatbot untuk toko air mineral. Jawablah pertanyaan seputar produk kami (Galon, Cup, Botol). Jangan menjawab pertanyaan di luar topik produk. Berikan jawaban yang ramah, informatif, dan singkat." }]
                }
            };
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                const text = result?.candidates?.[0]?.content?.parts?.[0]?.text || "Maaf, saya tidak dapat memproses permintaan ini saat ini.";
                loadingSpinner.classList.add('hidden');
                return text;
            } catch (error) {
                console.error("Kesalahan API:", error);
                loadingSpinner.classList.add('hidden');
                return "Maaf, terjadi kesalahan saat menghubungi server. Mohon coba lagi nanti.";
            }
        }

        function addMessage(sender, text) {
            const messageElement = document.createElement('div');
            messageElement.className = `flex mb-4 ${sender === 'user' ? 'justify-end' : 'justify-start'}`;
            messageElement.innerHTML = `
                <div class="chat-bubble rounded-xl p-3 ${sender === 'user' ? 'chat-user' : 'chat-bot'}">
                    <p>${text}</p>
                </div>
            `;
            chatbotMessages.appendChild(messageElement);
            chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
        }

        chatbotButton.onclick = () => {
            chatbotModal.classList.remove('hidden');
            addMessage(BOT_NAME, "Selamat datang! Saya bot Air Mineral. Ada yang bisa saya bantu terkait produk kami?");
        };

        closeChatbotButton.onclick = () => {
            chatbotModal.classList.add('hidden');
            chatbotMessages.innerHTML = '';
        };

        chatbotSendButton.onclick = async () => {
            const userMessage = chatbotInput.value.trim();
            if (userMessage === '') return;
            addMessage('user', userMessage);
            chatbotInput.value = '';

            const botResponse = await fetchChatResponse(userMessage);
            addMessage(BOT_NAME, botResponse);
        };

        chatbotInput.addEventListener('keypress', async (e) => {
            if (e.key === 'Enter') {
                chatbotSendButton.click();
            }
        });
    </script>
</body>
</html>
